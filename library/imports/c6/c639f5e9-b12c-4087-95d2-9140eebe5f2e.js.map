{"version":3,"sources":["assets\\scripts\\common\\managers\\ResourcesMgr.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["\nconst {ccclass, property} = cc._decorator;\n\n@ccclass\nexport default class ResMgr extends cc.Component {\n\n    public static Instance: ResMgr = null;\n\n    // AB包\n    private bundleSets: any = {};\n\n    private nowRes: number = 0;         // 已經加載的資源包\n    private totalRes: number = 0;       // 要加載的資源包總數\n\n    private nowBundle: number = 0;      // 已經加載過的AB\n    private totalBundle: number = 0;    // 總共要加載的AB\n\n    // 進度條\n    private onProgress: Function = null;\n    private onComplete: Function = null;\n\n    @property(cc.Prefab)\n    public prefabLoaderMobile: cc.Prefab = null;\n    @property(cc.Prefab)\n    public prefabLoaderPC: cc.Prefab = null;\n\n    /** 加載AB包 */\n    private loadAssetBundle(bundleName: string, onComplete: Function): void {\n        cc.assetManager.loadBundle(bundleName, (err, bundle) => {\n            if (err !== null) {\n                cc.log(`[ResMgr]: load asset bundle error: ${bundleName}`);\n                this.bundleSets[bundleName] = null;\n            } else {\n                cc.log(`[ResMgr]: load asset bundle success: ${bundleName}`);\n                this.bundleSets[bundleName] = bundle;\n            };\n            if (onComplete) {\n                onComplete();\n            };\n            // LogMgr.Instance.log(\"###### Asset bundles loaded:\", this.bundleSets);\n        });\n    }\n\n    onLoad (): void {\n        // 唯一實例\n        if (ResMgr.Instance === null) {\n            ResMgr.Instance = this;\n        } else {\n            cc.error(\"[error:] res mgr has multi instances!!!\");\n            this.destroy();\n            cc.log(\"[fix:] res mgr has been destroyed.\");\n            return;\n        };\n    }\n\n    /** 加載資源 */\n    public loadRes(bundle, url, typeOfClass) {\n        bundle.load(url, typeOfClass, (err, asset) => {\n            this.nowRes++;\n            \n            if (err) { \n                cc.error(`[load res]: ${url} error!`); \n            } else { \n                cc.log(`[load res]: ${url} success!`); \n            };\n\n            if (this.onProgress) {\n                this.onProgress(this.nowRes, this.totalRes);\n            };\n\n            if (this.nowRes >= this.totalRes) {\n                if (this.onComplete !== null) {\n                    this.onComplete();\n                }\n            };\n        });\n    }\n\n    /** 加載AB包中的特定資源 */\n    private loadSpecificAssetInBundle(resPkg) {\n        for (let key in resPkg) {\n            let urlSet = resPkg[key].urls;\n            let typeOfClass = resPkg.assetType;\n            for (let i =0 ; i < urlSet.length; i++) {\n                this.loadRes(this.bundleSets[key], urlSet[i], typeOfClass);\n            };\n        };\n    }\n\n    /** 獲取資源 */\n    public getAsset(bundleName: string, assetUrl: string): any {\n        let bundle = cc.assetManager.getBundle(bundleName);\n        if (bundle === null) {\n            cc.error(`[error:] \"${bundleName}\" asset bundle not loaded`);\n            return null;\n        };\n\n        return bundle.get(assetUrl);\n    }\n\n    /** 資源包預加載 || resPkg: || funcProgress: 進度函數 || onComplete: 加載結束函數 */\n    public preloadResPackage(resPkg, onProgress, onComplete): void {\n        this.nowRes = 0; this.totalRes = 0;\n        this.nowBundle = 0; this.totalBundle = 0;\n        this.onProgress = onProgress;\n        this.onComplete = onComplete;\n        for (let key in resPkg) {\n            this.totalBundle++;\n            this.totalRes += resPkg[key].urls.length;\n        };\n        for (let key in resPkg) {\n            this.loadAssetBundle(key, () => {\n                this.nowBundle++;\n                if (this.nowBundle === this.totalBundle) {\n                    this.loadSpecificAssetInBundle(resPkg);\n                }\n            });\n        };\n    }\n\n    /** 資源包釋放 */\n    public releaseResPackage(resPkg: object) {\n        for (let key in resPkg) {\n            if (!cc.isValid(resPkg[key])) {\n                continue;\n            };\n            let urlSet = resPkg[key].urls;\n            for (let i = 0; i < urlSet.length; i++) {\n                cc.assetManager.releaseAsset(urlSet[i]);\n            };\n        };\n    }\n}\n"]}